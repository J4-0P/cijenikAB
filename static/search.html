<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <title>Brinu me cijene</title>
    <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    }
  </script>
  <style>
    .scrollbar-left::-webkit-scrollbar {
  direction: rtl; /* Hack for some edge cases */
}

.scrollbar-left {
  direction: rtl; /* Flips scrollbar to left side */
}
.scrollbar-left > * {
  direction: ltr; /* Keep content reading left-to-right */
}

    @media (min-width: 768px) {
      html {
        font-size: 90%;
      }
      body {
        zoom: 0.9;
      }
    }
  </style>

  <style>
    input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  background: #f3f4f6; /* light mode */
  color: #374151;
}

.dark input[type="number"]::-webkit-inner-spin-button,
.dark input[type="number"]::-webkit-outer-spin-button {
  background: #374151; /* dark mode */
  color: #d1d5db;
}
    ::-webkit-scrollbar {
  width: 12px;
  background: #f3f4f6; /* Tailwind gray-100 */
}
::-webkit-scrollbar-thumb {
  background: #d1d5db; /* Tailwind gray-300 */
  border-radius: 6px;
}

/* Dark mode scrollbar */
.dark ::-webkit-scrollbar {
  background: #1f2937; /* Tailwind gray-800 */
}
.dark ::-webkit-scrollbar-thumb {
  background: #374151; /* Tailwind gray-700 */
}
html {
  scrollbar-color: #d1d5db #f3f4f6; /* thumb, track */
}
.dark {
  scrollbar-color: #374151 #1f2937;
}
input[type="number"] {
  color-scheme: light;
}
/* Dark mode */
.dark input[type="number"] {
  color-scheme: dark;
}
    .collapse-content {
      max-height: 0;
      overflow: hidden;
      opacity: 0;
      transition: max-height 0.3s ease, opacity 0.3s ease;
    }
    .hidden + button span,
    #category.hidden + button span {
      transform: rotate(-90deg);
    }
    .collapse-content.open {
      max-height: 500px; /* large enough for content */
      opacity: 1;
    }


  </style>
</head>
<script>
document.addEventListener('DOMContentLoaded', () => {
  function categorytoggle() {
  const btn = document.getElementById('category-filters-toggle');
  const dropdown = document.getElementById('category-filters');
  const arrow = document.getElementById('category-filters-arrow');
  if (!btn || !dropdown || !arrow) return;

  const expanded = btn.getAttribute('aria-expanded') === 'true';
  btn.setAttribute('aria-expanded', !expanded);
  dropdown.classList.toggle('hidden');
  arrow.style.transform = expanded ? 'rotate(0deg)' : 'rotate(180deg)';
}


});
function storetoggle(){
  const btn = document.getElementById('store-filters-toggle');
  const dropdown = document.getElementById('store-filters');
  const arrow = document.getElementById('store-filters-arrow');
  if (!btn || !dropdown || !arrow) return;

  const expanded = btn.getAttribute('aria-expanded') === 'true';
  btn.setAttribute('aria-expanded', !expanded);
  dropdown.classList.toggle('hidden');
  arrow.style.transform = expanded ? 'rotate(0deg)' : 'rotate(180deg)';
        document.getElementById('category-filters-toggle').addEventListener('click', categorytoggle);
document.getElementById('store-filters-toggle').addEventListener('click', storetoggle);
};
</script>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen flex items-center justify-center p-0 md:p-8">

  <!-- DESKTOP TITLE -->
  <div class="hidden md:fixed md:top-24 md:mb-[40px] md:block">
    <h1 class="text-5xl font-bold mb-2 text-gray-900 dark:text-gray-100"
        style="cursor:pointer;" onclick="location.href='/'">Brinu me cijene</h1>
  </div>

  <!-- MOBILE: Filters button fixed top -->


  <!-- MOBILE: Overlay when sidebar open -->


  <!-- Main app/maindiv -->
  <div
    class="pl-0 fixed top-0 left-0 md:top-48 md:left-1/2 md:-translate-x-1/2
      w-full h-screen md:w-full md:max-w-5xl md:h-[80vh]
      box-border bg-white dark:bg-gray-800 rounded-none md:rounded shadow-md p-4 md:p-6 flex flex-col md:flex-row gap-0 md:gap-8 border-0 md:border border-gray-300 dark:border-gray-700 maindiv pl-0
    "
    style="padding-left:15px;"
    >
  <div id="overlay"
    class="fixed inset-0 bg-black/60 transition-opacity duration-300 opacity-0 pointer-events-none md:hidden" style="z-index: 35;"></div>
    <!-- ASIDE: Sidebar -->
    <aside
      id="sidebar"
      class="
      
        scrollbar-left md:scrollbar-none
        overflow-x-hidden overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100 md:scrollbar-thumb-gray-300 md:scrollbar-track-gray-100 md:scrollbar-thin scrollbar-thumb-rounded-full scrollbar-track-rounded-full scrollbar-thumb-left
        fixed top-0 left-0 h-full w-72 max-w-full z-50 bg-white dark:bg-gray-800 shadow-lg p-6 transition-transform duration-300
        transform -translate-x-full
        md:static md:w-64 md:flex-shrink-0 md:h-auto md:translate-x-0 md:bg-transparent md:shadow-none md:p-0 md:sticky
      ">

      <!-- Close button on mobile -->
      <button id="sidebar-close"
        class="absolute top-4 right-4 block md:hidden text-2xl text-gray-600 dark:text-gray-300"
        aria-label="Zatvori filtere">&times;
      </button>
      <h1 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100 md:hidden">Brinu me cijene</h1>
      <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-gray-200">Filteri</h2>
      <div class="space-y-3">

        <!-- STORE FILTERS ACCORDION -->
        <div > 
          <button
            type="button"
            class="w-full flex justify-between items-center mb-2 font-semibold text-gray-900 dark:text-gray-200"
            aria-expanded="false"
            aria-controls="store-filters"
            id="store-filters-toggle"
          >
            Trgovina
            <span class="transition-transform duration-200" id="store-filters-arrow" style="display:inline-block; transform: rotate(-90deg);">▼</span>

          </button>
          <div id="store-filters" class="space-y-3 hidden mt-2 mb-4">
            <div class="flex items-center space-x-2">
              <input type="checkbox" value="Konzum" class="store-filter mr-2" id="store-kon" />
              <label for="store-kon" class="text-gray-900 dark:text-gray-200">Konzum</label>
            </div>
            <div class="flex items-center space-x-2">
              <input type="checkbox" value="Ribola" class="store-filter mr-2" id="store-rib" />
              <label for="store-rib" class="text-gray-900 dark:text-gray-200">Ribola</label>
            </div>
            <div class="flex items-center space-x-2">
              <input type="checkbox" value="Spar" class="store-filter mr-2" id="store-spa" />
              <label for="store-spa" class="text-gray-900 dark:text-gray-200">Spar</label>
            </div>
            <div class="flex items-center space-x-2">
              <input type="checkbox" value="Studenac" class="store-filter mr-2" id="store-stu" />
              <label for="store-stu" class="text-gray-900 dark:text-gray-200">Studenac</label>
            </div>
            <div class="flex items-center space-x-2">
              <input type="checkbox" value="Plodine" class="store-filter mr-2" id="store-plod" />
              <label for="store-plod" class="text-gray-900 dark:text-gray-200">Plodine</label>
            </div>
            <div class="flex items-center space-x-2">
              <input type="checkbox" value="Bakmaz" class="store-filter mr-2" id="store-bakmaz" />
              <label for="store-bakmaz" class="text-gray-900 dark:text-gray-200">Bakmaz</label>
            </div>
        </div>

        <!-- CATEGORY FILTERS ACCORDION -->
        <div>
          <button
            type="button"
            class="w-full flex justify-between items-center mb-2 font-semibold text-gray-900 dark:text-gray-200"
            aria-expanded="false"
            aria-controls="category-filters"
            id="category-filters-toggle"
          >
            Kategorija
            <span class="transition-transform duration-200" id="category-filters-arrow"  style="display:inline-block; transform: rotate(-90deg);">▼</span>
          </button>
          <div id="category-filters" class="space-y-3 hidden mt-2 mb-4">
            <div class="flex items-center space-x-2">
              <input type="checkbox" value="PROIZVODI ZA KUĆANSTVO" class="filter mr-2" id="cat-kućanstvo" />
              <label for="cat-kućanstvo" class="text-gray-900 dark:text-gray-200">Proizvodi za kućanstvo</label>
            </div>
            <div class="flex items-center space-x-2">
              <input type="checkbox" value="SREDSTVA ZA ČIŠĆENJE" class="filter mr-2" id="cat-čišćenje" />
              <label for="cat-čišćenje" class="text-gray-900 dark:text-gray-200">Sredstva za čišćenje</label>
            </div>
            <div class="flex items-center space-x-2">
              <input type="checkbox" value="HRANA" class="filter mr-2" id="cat-hrana" />
              <label for="cat-hrana" class="text-gray-900 dark:text-gray-200">Hrana</label>
            </div>
            <div class="flex items-center space-x-2">
              <input type="checkbox" value="KOZMETIKA" class="filter mr-2" id="cat-kozmetika" />
              <label for="cat-kozmetika" class="text-gray-900 dark:text-gray-200">Kozmetika</label>
            </div>
            <div class="flex items-center space-x-2">
              <input type="checkbox" value="PIĆE" class="filter mr-2" id="cat-piće" />
              <label for="cat-piće" class="text-gray-900 dark:text-gray-200">Piće</label>
            </div>
            <div class="flex items-center space-x-2">
              <input type="checkbox" value="TOALETNE POTREPŠTINE" class="filter mr-2" id="cat-toaletne" />
              <label for="cat-toaletne" class="text-gray-900 dark:text-gray-200">Toaletne potrepštine</label>
            </div>
          </div>
        </div>
        <div class="mb-4">
          <label for="search-category" class="font-semibold mb-2 block text-gray-900 dark:text-gray-200">Adresa</label>
          <input
            type="text"
            id="address-search"
            class="w-full border border-gray-300 dark:border-gray-600 rounded p-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200"
            placeholder="Upiši adresu..."
          />
        </div>
        <div class="mb-4">
          <label class="font-semibold mb-2 block text-gray-900 dark:text-gray-200">Cijena (€)</label>
          <div class="flex space-x-2">
            <input
              type="number"
              id="min-price"
              class="w-1/2 border border-gray-300 dark:border-gray-600 rounded p-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200"
              placeholder="Min"
              min="0"
              step="0.01"
            />
            <input
              type="number"
              id="max-price"
              class="w-1/2 border border-gray-300 dark:border-gray-600 rounded p-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200"
              placeholder="Max"
              min="0"
              step="0.01"
            />
          </div>
        </div>
        <div class="mb-4">
          <label for="brand-search" class="font-semibold mb-2 block text-gray-900 dark:text-gray-200">Marka</label>
          <input
            type="text"
            id="brand-search"
            class="w-full border border-gray-300 dark:border-gray-600 rounded p-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200"
            placeholder="Upiši marku..."
          />
        </div>
        <script>
          
        </script>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col mt-4 md:mt-0 overflow-auto">

      <!-- Search bar -->
      <div class="sticky top-0 z-30 bg-white dark:bg-gray-800 pb-2 flex flex-row align-center">
        <div class="relative flex-1 ">
          <input
            id="search"
            type="text"
            placeholder="Search items..."
            class="w-full border border-gray-300 dark:border-gray-600 rounded-full p-3 pr-12 text-lg focus:outline-none focus:ring-2 focus:ring-blue-400 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200"
          />
          <button
            id="search-button"
            class="absolute right-2 top-1/2 -translate-y-1/2 w-10 h-10 bg-gray-800 text-white rounded-full flex items-center justify-center hover:bg-gray-900 transition"
            aria-label="Search"
          >
            &rarr;
          </button>
        </div>

        <select
          id="search-field-select"
          class="w-[70px] md:w-[140px] border border-gray-300 dark:border-gray-600 rounded p-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200"
          aria-label="Search by field"
        >
          <option value="naziv">Naziv</option>
          <option value="barkod">Barkod</option>
        </select>
        <select
          id="sort-select"
          class="w-[60px] md:w-[140px] border border-gray-300 dark:border-gray-600 rounded p-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200"
          aria-label="Sort items"
        >
          <option value="">Sort</option>
          <option value="price-desc">Cijena ↓</option>
          <option value="price-asc">Cijena ↑</option>
          <option value="name-asc">Naziv A-Z</option>
          <option value="name-desc">Naziv Z-A</option>
        </select>
                <button id="mobile-filters-toggle"
          class="block w-[40px] md:hidden border border-gray-300 dark:border-gray-600 rounded p-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200"
          aria-label="Filteri">
          🔍
        </button>
      </div>

      <!-- Search results -->
      <section id="items" class="space-y-4 text-gray-900 dark:text-gray-200 ">
        <!-- JS inserts results here -->
      </section>
    </main>
  </div>

  <!-- Loading Spinner -->
<div id="loading-spinner" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50 hidden">
  <div class="w-16 h-16 border-4 border-blue-400 border-t-transparent rounded-full animate-spin"></div>
</div>

  <button
    id="dark-mode-toggle"
    class="fixed bottom-6 right-6 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 p-3 rounded shadow hover:bg-gray-300 dark:hover:bg-gray-600 transition"
    aria-label="Toggle dark mode"
  >
    🌓
  </button>


  <script>
    // MOBILE SIDEBAR TOGGLE LOGIC
    const toggleBtn = document.getElementById('mobile-filters-toggle');
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const closeBtn = document.getElementById('sidebar-close');
    function openSidebar() {
      sidebar.classList.remove('-translate-x-full');
      sidebar.classList.add('translate-x-0');
      overlay.classList.remove('opacity-0', 'pointer-events-none');
      overlay.classList.add('opacity-100', 'pointer-events-auto');
      document.body.classList.add('overflow-hidden');
    }
    function closeSidebar() {
      sidebar.classList.remove('translate-x-0');
      sidebar.classList.add('-translate-x-full');
      overlay.classList.remove('opacity-100', 'pointer-events-auto');
      overlay.classList.add('opacity-0', 'pointer-events-none');
      document.body.classList.remove('overflow-hidden');
    }
    // Hide sidebar if resizing
    window.addEventListener('resize', () => {
      if (window.innerWidth >= 640) closeSidebar();
    });

    if(toggleBtn) toggleBtn.onclick = openSidebar;
    if(closeBtn) closeBtn.onclick = closeSidebar;
    if(overlay) overlay.onclick = closeSidebar;
    // Hide sidebar by default on mobile
    closeSidebar(); // for initial load

    // ACCORDION LOGIC


    // Set up arrows initial state and event listeners



  </script>
</body>
</html>

  <script>
    
function mapCategory(str) {
    if (typeof str !== 'string' || str.length < 2) return null;
  const prefix = str.slice(0, 2).toUpperCase();
  const map = {
    'PI': 'PIĆE',
    'KO': 'KOZMETIKA',
    'PR': 'PROIZVODI ZA KUĆANSTVO',
    'TO': 'TOALETNE POTREPŠTINE',
    'SR': 'SREDSTVA ZA ČIŠĆENJE',
    'HR': 'HRANA'
  };

  return map[prefix] || null;
}

    window.addEventListener('DOMContentLoaded', () => {
      console.log("OK")


      filters.forEach(f => f.addEventListener("change", filterItems));
document.querySelectorAll(".category-filter, .store-filter").forEach(f => 
  f.addEventListener("change", filterItems)
);
document.querySelectorAll("#address-search").forEach(f => 
  f.addEventListener("input", filterItems)

);
document.getElementById("brand-search").addEventListener("input", filterItems);


    searchInput.addEventListener("change", filterItems);
    filters.forEach(f => f.addEventListener("change", filterItems));
  const params = new URLSearchParams(window.location.search);
        const typeParam = params.get('type') || 'naziv'; // default to 'naziv' if not set
  const searchQuery = params.get('query');
  console.log("Type param:", typeParam);
  console.log("Search query:", searchQuery);
  if (searchQuery) {
    console.log("Search query:", searchQuery);
    const input = document.getElementById('search');
    const button = document.getElementById('search-button');
    if (typeParam === "barcode") {
      document.getElementById("search-field-select").value = "barkod";
      console.log(parseInt(params.get('query')) % 1000);
      const searchStr = params.get('query') || '';
      const last4 = searchStr.slice(-4);
      document.title = "Rezultati za barkod ..." + last4;
    } else {
      document.title = "Rezultati za " + searchQuery;
    }
    input.value = searchQuery;
    console.log("Setting input value to:", searchQuery);
    button.click(); // or call your search function directly
  }
});
    document.querySelectorAll("button[id$='-toggle']").forEach(btn => {
      btn.addEventListener("click", () => {
        const contentId = btn.id.replace(/-toggle$/, "");
        const content = document.getElementById(contentId);
        if (!content) return;

        const hidden = content.classList.toggle("hidden");
        const arrow = btn.querySelector("span");
        if (arrow) arrow.style.transform = hidden ? "rotate(-90deg)" : "rotate(0deg)";
        btn.setAttribute("aria-expanded", !hidden);
      });
    });

    

var items = [];
const input = document.getElementById("search");
const button = document.getElementById("search-button");
document.querySelectorAll('.store-filter').forEach(el => {
  el.addEventListener('change', filterItems);
});

input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault(); // prevent form submission or other side effects
    button.click();
  }
});
  document.getElementById('search-button').addEventListener('click', async () => {
    const query = document.getElementById('search').value.trim();
    if (!query) return;

    // Show spinner
    document.getElementById('loading-spinner').classList.remove('hidden');

    // Clear previous results and items before new search
    items.length = 0;
    itemsContainer.innerHTML = "";

    try {
      
  // Returns true if at least one string length >= 3,
  // else does something (like return or assign x)
const queryParts = query.trim().split(" ");
if (queryParts.every(s => s.length < 3)) {
  console.warn("Query too short — skipping request.");
  filterItems(); // or show an error to the user
  return;
}

const response = await fetch(`search?query=${encodeURIComponent(query)}&type=${document.getElementById("search-field-select").value}`);
if (!response.ok) throw new Error('Network error');

const reader = response.body.getReader();
const decoder = new TextDecoder();
let buffer = '';
i = 0
const startTime = performance.now();
items = [];
while (true) {
  i += 1;
  if (i == 5){
    console.log("This took", performance.now() - startTime, "ms");
    document.getElementById('loading-spinner').classList.add('hidden');

  }
  const { done, value } = await reader.read();
  if (done){
    
     break;
  }
  buffer += decoder.decode(value, { stream: true });
  let lines = buffer.split('\n');
  buffer = lines.pop(); // Keep the last (maybe incomplete) line in buffer

  for (const line of lines) {
    if (line.trim() === "") continue;
    const item = JSON.parse(line);
    // process each item as it arrives:
    items.push(item);
    itemsContainer.appendChild(createResultElement(item));
  }
}

// If buffer has remaining data, process that last line:
if (buffer.trim() !== "") {
  const item = JSON.parse(buffer);
  items.push(item);
  itemsContainer.appendChild(createResultElement(item));
}
      filterItems();
    } catch (error) {
      console.error('Failed to fetch search results:', error);
    } finally {
      // Hide spinner
      document.getElementById('loading-spinner').classList.add('hidden');
    }
  });
    const itemsContainer = document.getElementById("items");
    const searchInput = document.getElementById("search");
    const filters = document.querySelectorAll(".filter");
function createResultElement(item) {
  addressFilter = document.getElementById("address-search").value;
  const div = document.createElement("div");
  div.className = "border border-gray-200 rounded p-4 shadow-sm hover:shadow-md transition";
let cijena = parseFloat(item.maloprodajna_cijena);
if (isNaN(cijena) || cijena <= 0) {
  cijena = "?";
} else {
  cijena = cijena.toFixed(2);
}
let thing = "€" + cijena + "/kom";

if (item.jedinica_mjere.toUpperCase() != "KOM") {
  let cijenaMjere = parseFloat(item.cijena_za_jedinicu_mjere);
  cijenaMjere = isNaN(cijenaMjere) ? "?" : cijenaMjere.toFixed(2);
  thing = "€" + (isNaN(parseFloat(item.maloprodajna_cijena)) ? "?" : parseFloat(item.maloprodajna_cijena).toFixed(2)) + "/kom <br><small>(€" + cijenaMjere + "/" + item.jedinica_mjere + ")</small>";
}

function titleCase(str) {
    return str.replace(/\b(hipermarket|supermarket)\b/gi, '').toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ')
}




  // Filter addresses based on the addressFilter (case-insensitive)
  const filteredAddresses = item.adresa[0].filter(addr => 
    addr.toLowerCase().includes(addressFilter.toLowerCase()) || addr.trim() === "*"
  );

  // If filtering removes all addresses, show some fallback
  const addressesHtml = filteredAddresses.length
    ? filteredAddresses.map(addr => `<a class="hover:bg-gray-300 dark:hover:bg-gray-700" href="https://www.google.com/maps/search/${encodeURIComponent(addr)}" target="_blank" rel="noopener noreferrer">${titleCase(addr)}</a>`).join('<br>')
    : null;

   const num = filteredAddresses.length;
  let somevar;


    const lastDigit = num % 10;
    const lastTwoDigits = num % 100;
    if (filteredAddresses.length === 1 && filteredAddresses[0].trim() === "*") {
      somevar = "Na svim adresama";
    } else
    if (num === 1) {
      somevar = "Na jednoj adresi";
    } else if (lastDigit === 1 && lastTwoDigits !== 11) {
      somevar = `Na ${num} adresu`;
    } else if (lastDigit >= 2 && lastDigit <= 4 && !(lastTwoDigits >= 12 && lastTwoDigits <= 14)) {
      somevar = `Na ${num} adrese`;
    } else {
      somevar = `Na ${num} adresa`;
    }

  div.innerHTML = `
<div class="flex justify-between items-start mb-2 ">
  <div class="flex flex-col">
  <h3 class="font-semibold text-lg leading-none">${item.naziv}</h3>
  <h4 class="text-gray-600 dark:text-gray-400 text-md">${item.marka || "Nema marke"}</h4>
  </div>
  <div class="flex flex-col items-end">
    <div class="text-green-700 font-bold text-lg">${thing}</div>
    <div class="text-sm text-gray-600 dark:text-gray-400 mt-1 ">${item.barkod}</div>
  </div>
</div>

<p class="text-gray-600 dark:text-gray-300 mb-2">
  ${somevar}
  ${somevar === "Na svim adresama" ? "" : '<button class="text-blue-500 ml-2 toggle-dropdown">+</button>'}
</p>
<div class="dropdown-content hidden mb-2 text-sm text-gray-700 dark:text-gray-400 ">
  ${addressesHtml}
</div>
<div class="flex space-x-2">
  <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded">${mapCategory(item.kategorije)}</span>
  <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded">${item.trgovina}</span>

  
</div>
`;

  const button = div.querySelector('.toggle-dropdown');
  const dropdown = div.querySelector('.dropdown-content');


    if (button) {
      button.addEventListener('click', () => {
        dropdown.classList.toggle('hidden');
      });
    }


  return div;
}


    function renderItems(filteredItems) {
      itemsContainer.innerHTML = "";
      if (filteredItems.length === 0) {
        if (!document.getElementById('loading-spinner').classList.contains('hidden')) {
          // Don't show "no results" while loading
          return;
        }
      
        itemsContainer.innerHTML = "<p class='text-gray-500 dark:text-gray-400'>Nema rezultata. Probajte tražiti ponovno ili promijeniti filtere.</p>";
        return;
      }
      filteredItems.forEach(item => {
        resault = createResultElement(item);
        if (resault !== null){
        itemsContainer.appendChild(createResultElement(item));
        }
      });
    }


function filterItems() {
  console.log("FILTRIRAM");
  const searchTerm = searchInput.value.toLowerCase().trim();
  const terms = searchTerm.split(/\s+/); // split by any whitespace
  document.querySelector("h2").textContent = "Filteri za " + terms.join(", ") + ` (${items.length})`;
  const selectedCategories = Array.from(document.querySelectorAll(".filter"))
    .filter(f => f.checked)
    .map(f => f.value);

  const selectedStores = Array.from(document.querySelectorAll(".store-filter"))
    .filter(cb => cb.checked)
    .map(cb => cb.value);

  // Get address filter value
  const addressTerm = document.getElementById("address-search").value.toLowerCase().trim();
  const counts = {
    STORES: {},
    CATEGORIES: {}
  };
  // Get min and max price inputs as numbers or null if empty/invalid
  const minPriceInput = document.getElementById("min-price").value;
  const maxPriceInput = document.getElementById("max-price").value;
  const minPrice = minPriceInput ? parseFloat(minPriceInput) : null;
  const maxPrice = maxPriceInput ? parseFloat(maxPriceInput) : null;

  const filtered = items.filter(item => {
    // Determine price to check: maloprodajna_cijena first, then cijena_za_jedinicu_mjere
    const priceRaw = item.maloprodajna_cijena ?? item.cijena_za_jedinicu_mjere;
    if (!priceRaw) return false; // no price, skip

    // parse price as float (handle comma decimal if needed)
    const price = parseFloat(String(priceRaw).replace(",", "."));
    if (isNaN(price)) return false;

    // Check min/max price filters
    if (minPrice !== null && price < minPrice) return false;
    if (maxPrice !== null && price > maxPrice) return false;

    // Search field filtering (dynamic key)
    const searchField = document.getElementById("search-field-select").value;
    const matchesSearch = terms.every(term =>
      item[searchField]?.toLowerCase().includes(term)
    );

    const matchesCategory =
      selectedCategories.length === 0 ||
      selectedCategories.some(cat => item.kategorije.startsWith(cat.slice(0, 2)));

    const matchesStore =
      selectedStores.length === 0 || selectedStores.includes(item.trgovina);

    const matchesAddress =
      !addressTerm || item.adresa[0].some(addr => addr.toLowerCase().includes(addressTerm));

    const matchesBrand = !document.getElementById("brand-search").value ||
      item.marka.toLowerCase().includes(document.getElementById("brand-search").value.toLowerCase());
      // Count stores
      // Only count for items that pass all filters (i.e., currently displayed)
      // (moved counting after filtering)
      return matchesSearch && matchesCategory && matchesStore && matchesAddress && matchesBrand;
      });

      // Count stores and categories in the filtered results
      filtered.forEach(item => {
        console.log(item.marka);
      if (item.trgovina) {
        counts.STORES[item.trgovina] = (counts.STORES[item.trgovina] || 0) + 1;
      }
      if (item.kategorije && typeof item.kategorije === "string") {
        const catKey = item.kategorije.slice(0, 2).toUpperCase();
        counts.CATEGORIES[catKey] = (counts.CATEGORIES[catKey] || 0) + 1;
      }
      });
      

console.log("Counts:", counts);
document.querySelectorAll(".store-filter").forEach(cb => {
  const label = document.querySelector(`label[for="${cb.id}"]`);
  if (label) {
    console.log("Setting label for", cb.id, "to", cb.value);
    const count = counts.STORES[cb.value] || 0;
    label.innerHTML = `${cb.value} <span class="text-xs text-gray-500 dark:text-gray-400">(${count})</span>`;
  }
});
document.querySelectorAll(".filter").forEach(cb => {
  const label = document.querySelector(`label[for="${cb.id}"]`);
  if (label) {
    console.log("Setting label for", cb.id, "to", cb.value);
    // Use first two letters to match counts.CATEGORIES
    const catKey = cb.value.slice(0, 2).toUpperCase();
    const count = counts.CATEGORIES[catKey] || 0;
    label.innerHTML = `${label.textContent.replace(/\s*\(\d+\)$/, '')} <span class="text-xs text-gray-500 dark:text-gray-400">(${count})</span>`;
  }
});

  // Update category and store counts in the UI
  

  // Count all keys 'kategorija' and 'trgovina'


  // Count occurrences of kategorija and trgovina

  renderItems(filtered);
}
document.getElementById("min-price").addEventListener("input", filterItems);
document.getElementById("max-price").addEventListener("input", filterItems);





    // Initial render
    renderItems(items);
    filterItems();
    // Dark mode toggle logic
    const darkModeToggle = document.getElementById("dark-mode-toggle");

    darkModeToggle.addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
      if (document.documentElement.classList.contains("dark")) {
        localStorage.setItem("dark-mode", "enabled");
      } else {
        localStorage.removeItem("dark-mode");
      }
    });

    // Apply saved preference on load
    if (localStorage.getItem("dark-mode") === "enabled") {
      document.documentElement.classList.add("dark");
    }
function parsePrice(str) {
  if (!str) return -Infinity; // treat missing price as very low to push it first (or use Infinity to push last)
  return parseFloat(str.replace(',', '.')) || -Infinity;
}
function sortItems(){
  const val = document.getElementById("sort-select").value;
  if (!val) return renderItems(items);

  const sorted = [...items];

  function getSortPrice(item) {
    // Use maloprodajna_cijena if available, otherwise cijena_za_jedinicu_mjere
    let price = item.maloprodajna_cijena ?? item.cijena_za_jedinicu_mjere;
    if (!price) return -Infinity;
    return parseFloat(String(price).replace(',', '.')) || -Infinity;
  }

  if (val === "price-asc") {
    sorted.sort((a, b) => getSortPrice(a) - getSortPrice(b));
  } else if (val === "price-desc") {
    sorted.sort((a, b) => getSortPrice(b) - getSortPrice(a));
  } else if (val === "name-asc") {
    sorted.sort((a, b) => a.naziv.localeCompare(b.naziv));
  } else if (val === "name-desc") {
    sorted.sort((a, b) => b.naziv.localeCompare(a.naziv));
  }

  renderItems(sorted);
}
document.getElementById("sort-select").addEventListener("change", (e) => {
  sortItems()
});
  sortItems();

  </script>

</body>
</html>
